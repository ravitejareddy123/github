name: KinD CI/CD and GitHub Pages Deployment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

env:
  DOCKER_REGISTRY: ghcr.io
  DOCKER_IMAGE: myimage
  K8S_NAMESPACE: default
  DEPLOYMENT_NAME: microservice

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    steps:
      # ----- Setup -----
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: |
          pip install pyautogen pandas requests scikit-learn transformers torch pytest autogen markdown

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ----- Build & Test -----
      - name: Train Build Agent
        run: python train_agents.py build

      - name: Train Test Agent
        run: python train_agents.py test

      - name: Build Docker Image and Export
        uses: docker/build-push-action@v6
        with:
          tags: ${{ env.DOCKER_IMAGE }}:latest
          outputs: type=docker,dest=${{ runner.temp }}/myimage.tar

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: myimage
          path: ${{ runner.temp }}/myimage.tar

      - name: Build and Push Docker Image
        run: python build_agent.py

      - name: Run Unit Tests
        run: python test_agent.py

      - name: Upload Build and Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: build-test-report
          path: |
            build_report.json
            test_report.json

      # ----- KinD Deployment -----
      - name: Install KinD and kubectl
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x ./kubectl && sudo mv ./kubectl /usr/local/bin/

      - name: Create KinD Cluster
        run: kind create cluster --name demo-cluster --config kind-config.yaml

      - name: Load Docker Image into KinD
        run: |
          docker load --input ${{ runner.temp }}/myimage.tar
          kind load docker-image ${{ env.DOCKER_IMAGE }}:latest --name demo-cluster

      - name: Train Deploy Agent
        run: python train_agents.py deploy

      - name: Deploy to KinD
        run: python deploy_agent.py

      - name: Upload Deploy Report
        uses: actions/upload-artifact@v4
        with:
          name: deploy-report
          path: deploy_report.json

      # ----- Log Analysis -----
      - name: Set KinD Context
        run: |
          kind get kubeconfig --name demo-cluster > kindconfig.yaml
          export KUBECONFIG=kindconfig.yaml

      - name: Train Log Analyst Agent
        run: python train_agents.py log_analyst

      - name: Run AutoGen Log Analysis
        run: python autogen_log_analysis.py

      - name: Upload Log Analysis Report
        uses: actions/upload-artifact@v4
        with:
          name: log-analysis-report
          path: log_analysis_report.html

      # ----- GitHub Pages Deployment -----
      

      - name: Copy UI to docs
        run: |
          mkdir -p docs
          ##cp build_report.json docs/
          cp index.html docs/
          ls -ltr
          cd docs
          cat index.html
          cat log_analysis_report.html
          ls -ltr

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
